# Vue Bridge Gateway

Vue-Bridge-Gateway is a wrapper of **WebviewJavascriptBridge** (`$bridge`) and **AxiosHttp** (`$fetch`) to make building Mini apps simple and easy.

## Install

_yarn_

```bash
yarn add vue-bridge-gateway
```

_npm_

```bash
npm i vue-bridge-gateway
```

## Register Vue 2

```js
// main.js
import Vue from "vue";
import VueBridgeGateway from "vue-bridge-gateway";
Vue.use(VueBridgeGateway, { debug: true, delay: 200 });
```

## Register Vue 3

```js
// main.js
import Vue from "vue";
import VueBridgeGateway from "vue-bridge-gateway";
const app = createApp(AppLayout);
app.use(VueBridgeGateway, { debug: true, delay: 200 });
```

> After registration, you'll have acess to global methods `$bridge`
> and `$fetch`

<br />

## Configurations (Options)

| Key     | Type    | Default | Description                                                                                                       |
| ------- | ------- | ------- | ----------------------------------------------------------------------------------------------------------------- |
| _debug_ | Boolean | `true`  | console output call information                                                                                   |
| _delay_ | Number  | `200`   | The processing of registerHandler failure caused by birdge initialization takes time, delay call time, value `ms` |

<br />

> It is best to delay the method of calling the front-end registration by native to avoid the problems caused by the native call when the front-end has not been registered.

## 1. `$bridge`

- WebviewJavascriptBridge plugin for Vue.js
- Based on [WebViewJavascriptBridge](https://github.com/marcuswestin/WebViewJavascriptBridge) (iOS), [JsBridge](https://github.com/lzyzsd/JsBridge) (android) Development
- Promise Encapsulationï¼Œsupport `then` or `async/await`

**Methods**

1.  `registerHandler`
    <br />
    <br />
    - **description**: Register a handler for listening to native app call. The first parameter a name that will be provided by native app, the second parameter is a callback function (optional).
      <br />
      <br />
    ```js
    this.$bridge.registerHandler("myListener", (data, callback) => {
      console.log("data from native:", data);
      const responseData = { "Javascript Says": "Right back atcha!" };
      console.log("JS responding to native with", responseData);
      callback(responseData);
    });
    ```
2.  `callHandler`
    <br />
    <br />
    - **description**: Communicate between native app and mini app. The first parameter is the name provided by native app, the second parameter (optional) is the request body.
      <br />
      <br />
    ```js
    // tell native app to set bar title to "Home Page"
    this.$bridge
      .callHandler("setBarTitle", { title: "Home Page" })
      .then(() => {
        // do something
      })
      .catch(() => {
        // handle error
      });
    ```

## 2. `$fetch`

- Wrapper of [Axios](https://axios-http.com/docs/api_intro) library
- Custom methods but use the same configurations as axios

**WhiteList**
Native app will block all network requests that not being called by our method `$fetch`. When your vuejs bootstraped, the plugin will call to bridge handler name _"getProfile"_ and it will return an array of whitelist URLs which prevent the `$fetch` methods to call to other endpoints that aren't included in the whitelist.

**Methods**

1. `setHeader`
   <br />
   <br />

   - **description:** set global header for every `$fetch` request.
     <br />
     <br />

   ```js
   // main.js
   import Vue from "vue";
   import VueBridgeGateway, { $fetch } from "vue-bridge-gateway";

   $fetch.setHeaders({
     "X-Requested-With": "XMLHttpRequest",
     "Other-Header": "123456",
   });

   Vue.use(VueBridgeGateway);
   ```

   or

   ```js
   // layout.vue
   this.$fetch.setHeaders({
     "X-Requested-With": "XMLHttpRequest",
     "Other-Header": "123456",
   });
   ```

2. `request`
   <br />
   <br />
   - **description:** accept one parameter **config**
     <br />
     <br />
   ```js
   // ExamplePage.vue
   this.$fetch
     .request({
       method: "GET",
       url: "https://jsonplaceholder.typicode.com/todos/1",
       headers: { "X-Requested-With": "XMLHttpRequest" },
       responseType: "json", // default
       cancelToken: new CancelToken(function (cancel) {}),
       // more configurations can be found at https://axios-http.com/docs/req_config
     })
     .then((res) => {
       // do something with response data
     })
     .catch((err) => {
       // handle error
     });
   ```
3. `handleError`
   <br />
   <br />

   - **description:** handle http call error globally
     <br />
     <br />

   ```javascript
   // layout.vue
   this.$fetch.handleError((error) => {
     console.log(error.response.data);
     console.log(error.response.status);
     console.log(error.response.headers);
   });
   ```

    <br />
    <br />

   - **handle error in separate file**
     <br />
     <br />

   ```js
    // main.js

    import VueBridgeGateway, { $fetch } from "vue-bridge-gateway";
    import errorHandler from "./plugins/interceptError";

    ...
    errorHandler($fetch);
    app.use(VueBridgeGateway)
    app.mount("#app")
   ```

   <br />

   ```js
   // plugins/interceptError.js

   export function($fetch) {
     $fetch.handleError((error) => {
       // handle error globally
       console.log("error: ", error);
     });
   };
   ```

4. `get`, `delete`, `head`, `options`
   <br />
   <br />
   - **description:** Use the same axios methods. More configurations can be found at [axios](https://axios-http.com/docs/req_config) website.
     <br />
     <br />
   ```javascript
   this.$fetch.get('https://example.come', OPTIONAL_CONFIGURATIONS).then(
   	(res) => {
   		// do something with response
   	}).(error) => {
   		// handle error
   	})
   ```
5. `patch`, `post`, `put`
   <br />
   <br />
   - **description:** Use the same axios methods. More configurations can be found at [axios](https://axios-http.com/docs/req_config) website.
     <br />
     <br />
   ```javascript
   const payload = {
   	brand: 'Kawasaki',
   	model: 'z125',
   }
   this.$fetch.get('https://example.come', payload, OPTIONAL_CONFIGURATIONS).then(
   	(res) => {
   		// do something with response
   	}).(error) => {
   		// handle error
   	})
   ```

## Access `$fetch` in Store

### Pinia

```js
// main.js
import App from "./App.vue";
import { createApp } from "vue";
import { createPinia } from "pinia";

import VueBridgeGateway, { $fetch } from "vue-bridge-gateway";

const app = createApp(App);
const pinia = createPinia();

// register fetch to pinia
pinia.use(({ store }) => {
  store.$fetch = $fetch;
});

// register bridge
app.use(VueBridgeGateway);
app.use(pinia).use(router).mount("#app");
```

```js
// store/user.js
import { defineStore } from "pinia";
const api = "https://jsonplaceholder.typicode.com/users";
export const useUserStore = defineStore({
  id: "user",
  state: () => ({
    users: [],
  }),
  getters: {
    totalUser: (state) => state.users.length,
  },
  actions: {
    fetchUsers() {
      return this.$fetch.get(api).then((res) => {
        this.users = res.data;
      });
    },
  },
});
```

### Vuex

```js
// main.js
import { createApp } from "vue";
import store from "./store";
import VueJsBridge, { $fetch } from "bridge-gateway";
const app = createApp();
store.$fetch = $fetch;
app.use(VueJsBridge).use(store).mount("#app");
```

```js
// store/index.js
import { createStore } from "vuex";
const store = createStore({
  state: {},
  mutations: {},
  actions: {
    fetchData() {
      return new Promise((resolve) => {
        this.$fetch
          .get("https://api.example.com", {
            headers: {
              customHeader: 123456789,
            },
          })
          .then((res) => {
            console.log(res);
            resolve(res);
          });
      });
    },
  },
});

export default store;
```

## Vue 3 Composition API

For composition API you can access bridge instance by using [provide/inject](https://v3.vuejs.org/guide/component-provide-inject.html)

```js
// CompositionAPI.vue
<script>
import { inject, onMounted } from  'vue'
export  default {
	setup() {
		const $fetch  =  inject('$fetch')
		const $bridge = inject('$bridge')

		onMounted(() => {
			$bridge.callHandler('setBarTitle', { title:  'Home Page' })
				.then(() => { /* do something */ })
				.catch(() => { /* handle error */ })

			$fetch.get('https://gorest.co.in/public/v1/posts')
				.then((res) => { /* do something */ })
				.catch(() => { /* handle error */ })
		})
	},
}
</script>
```

## Links

[Mini app boilerplate](https://github.com/ABA-Bank/mini-app-boilerplate)

[Release Notes](https://github.com/ABA-Bank/Vue-Bridge-Gateway-Release-Note)
